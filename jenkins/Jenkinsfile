pipeline {
    agent any

    options {
        // buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    stages {
        stage('Build') {
            steps {
                script {
                    sh 'docker build -f jenkins/Dockerfile -t ${JOB_NAME}:${BUILD_NUMBER} .'
                    sh 'docker tag ${JOB_NAME}:${BUILD_NUMBER} ${JOB_NAME}:latest'

                    // // Alternatively, login to registry and build/push image. Replace the registry URL and
                    // // credential ID with your own (credentials managed via Jenkins CasC).
                    // docker.withRegistry('https://my.registry.example', 'docker-creds') {
                    //     def img = docker.build("${env.JOB_NAME}:${env.BUILD_NUMBER}", "-f jenkins/Dockerfile .")
                    //     img.push()
                    //     img.push('latest')
                    // }
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    // Use withCredentials to scope and mask the secret during this block
                    withCredentials([string(credentialsId: 'openai-api-key', variable: 'OPENAI_API_KEY'), string(credentialsId: 'google-api-key', variable: 'GOOGLE_API_KEY')]) {
                        // Run container with a name so we can copy files from it later
                        sh 'docker run --name workout-container-${BUILD_NUMBER} -e OPENAI_API_KEY=$OPENAI_API_KEY -e GOOGLE_API_KEY=$GOOGLE_API_KEY $JOB_NAME:$BUILD_NUMBER'
                        
                        // Copy output files from container directly to the Jenkins workspace root
                        sh 'docker cp workout-container-${BUILD_NUMBER}:/app/workout_plan.json . || true'
                        sh 'docker cp workout-container-${BUILD_NUMBER}:/app/workout_plan.toon . || true'
                        
                        // Clean up the container
                        sh 'docker rm workout-container-${BUILD_NUMBER}'
                    }
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                script {
                    // Archive the output files from the workspace root
                    archiveArtifacts artifacts: 'workout_plan.json, workout_plan.toon', 
                                     allowEmptyArchive: true,
                                     fingerprint: true
                }
            }
        }
    }

    post {
        always {
            cleanWs() // needs workspace-cleanup plugin
            // deleteDir() // built-in Jenkins step
        }
    }
}
