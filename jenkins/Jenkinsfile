pipeline {
    agent any

    options {
        // buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    stages {
        stage('Build') {
            steps {
                script {
                    sh 'docker build -f jenkins/Dockerfile -t ${JOB_NAME}:${BUILD_NUMBER} .'
                    sh 'docker tag ${JOB_NAME}:${BUILD_NUMBER} ${JOB_NAME}:latest'

                    // // Alternatively, login to registry and build/push image. Replace the registry URL and
                    // // credential ID with your own (credentials managed via Jenkins CasC).
                    // docker.withRegistry('https://my.registry.example', 'docker-creds') {
                    //     def img = docker.build("${env.JOB_NAME}:${env.BUILD_NUMBER}", "-f jenkins/Dockerfile .")
                    //     img.push()
                    //     img.push('latest')
                    // }
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    // Use withCredentials to scope and mask the secret during this block
                    withCredentials([string(credentialsId: 'openai-api-key', variable: 'OPENAI_API_KEY'), string(credentialsId: 'google-api-key', variable: 'GOOGLE_API_KEY')]) {
                        // Run container and mount current directory to copy output files
                        sh 'docker run --rm -e OPENAI_API_KEY=$OPENAI_API_KEY -e GOOGLE_API_KEY=$GOOGLE_API_KEY -v ${WORKSPACE}/output:/app/output $JOB_NAME:$BUILD_NUMBER'
                    }
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                script {
                    // Archive the output files as Jenkins artifacts
                    archiveArtifacts artifacts: 'output/*.json, output/*.toon', 
                                     allowEmptyArchive: true,
                                     fingerprint: true
                }
            }
        }
    }

    post {
        always {
            // cleanWs() // needs workspace-cleanup plugin
            deleteDir() // built-in Jenkins step
        }
    }
}
